<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Map – Supplier Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: #fff;
      height: 100vh;
      overflow: hidden;
      padding-top: 40px;
    }

    /* ── Proto nav ── */
    .proto-nav {
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 9999; height: 40px; background: #000;
      display: flex; align-items: center; gap: 12px; padding: 0 16px;
      font-family: 'Inter', system-ui, sans-serif;
    }
    .proto-nav-library {
      display: flex; align-items: center; gap: 8px;
      text-decoration: none; color: #fff; font-size: 14px; font-weight: 500;
      letter-spacing: -0.28px; line-height: 24px; white-space: nowrap; flex-shrink: 0;
    }
    .proto-nav-library:hover { opacity: 0.75; }
    .proto-nav-library svg { width: 20px; height: 20px; flex-shrink: 0; }
    .proto-nav-title { flex: 1; color: #fff; font-size: 14px; font-weight: 500; letter-spacing: -0.28px; line-height: 24px; }
    .proto-nav-updated { flex: 0 0 auto; color: #fff; font-size: 14px; font-weight: 400; letter-spacing: -0.28px; line-height: 24px; white-space: nowrap; }

    /* ── Map layout ── */
    .map-layout {
      position: fixed;
      top: 40px; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .map-header {
      padding: 24px 40px 16px;
      flex-shrink: 0;
    }
    .map-title {
      font-size: 36px;
      font-weight: 600;
      color: #334155;
      letter-spacing: -1.44px;
      line-height: 40px;
    }

    /* ── Map viewport (pannable area) ── */
    .map-viewport {
      flex: 1;
      min-height: 0;
      overflow: hidden;
      cursor: grab;
      position: relative;
    }
    .map-viewport.is-dragging { cursor: grabbing; }

    .map-canvas {
      position: absolute;
      left: 0; top: 0;
      width: 1800px;
      height: 660px;
      transform-origin: 0 0;
    }

    .map-svg {
      position: absolute;
      inset: 0;
      width: 1800px;
      height: 660px;
      pointer-events: none;
      overflow: visible;
    }

    /* ── Map nodes ── */
    .map-node {
      position: absolute;
      padding: 16px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #334155;
      letter-spacing: -0.32px;
      line-height: 26px;
      text-decoration: none;
      white-space: nowrap;
      cursor: pointer;
      transition: box-shadow 0.15s ease;
      user-select: none;
    }
    .map-node:hover {
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }
    .map-node.is-current {
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.06);
    }
    .map-node.auth {
      background: #ddd6fe;
      border: 1px solid #a78bfa;
    }
    .map-node.portal-main {
      background: #ccdafb;
      border: 1px solid #5483f2;
    }
    .map-node.portal-sub {
      background: #ccdafb;
    }
    .map-node.onboarding {
      background: #d1fae5;
      border: 1px solid #34d399;
    }

    /* ── Zoom controls ── */
    .zoom-controls {
      position: fixed;
      bottom: 24px;
      left: 24px;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }
    .zoom-btn {
      background: #fff;
      border: 1px solid #94a3b8;
      margin-bottom: -1px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #475569;
      width: 40px;
      height: 40px;
      transition: background 0.15s;
    }
    .zoom-btn:first-child { border-radius: 8px 8px 0 0; }
    .zoom-btn:last-child { border-radius: 0 0 8px 8px; margin-bottom: 0; }
    .zoom-btn:hover { background: #f1f5f9; }
    .zoom-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
  </style>
</head>
<body>

  <!-- Proto nav -->
  <nav class="proto-nav">
    <a href="index.html" class="proto-nav-library">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
      </svg>
      Library
    </a>
    <span class="proto-nav-title">Prototype / Portal</span>
    <a href="map.html" class="proto-nav-library">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
      </svg>
      Map
    </a>
    <span class="proto-nav-updated" id="protoLastUpdated"></span>
  </nav>

  <!-- Map layout -->
  <div class="map-layout">
    <div class="map-header">
      <h1 class="map-title">Map</h1>
    </div>
    <div class="map-viewport" id="mapViewport">
      <div class="map-canvas" id="mapCanvas">
        <svg class="map-svg" id="mapSvg"></svg>
        <!-- Nodes injected by JS -->
      </div>
    </div>
  </div>

  <!-- Zoom controls -->
  <div class="zoom-controls">
    <button class="zoom-btn" id="zoomInBtn" title="Zoom in" aria-label="Zoom in">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
      </svg>
    </button>
    <button class="zoom-btn" id="zoomOutBtn" title="Zoom out" aria-label="Zoom out">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/>
      </svg>
    </button>
  </div>

  <script>
    // ── Node definitions ──────────────────────────────────────────────────────
    // Positions match the Figma design layout (x, y = top-left of node box)
    var NODES = [
      // Auth flow (purple)
      { id: 'signin',       label: 'Sign in',          x: 574,  y: 147, href: 'login.html',                       color: 'auth',       key: 'signin'       },
      { id: 'otp',          label: 'OTP',              x: 766,  y: 100, href: 'login.html',                       color: 'auth',       key: 'otp'          },
      { id: 'magiclink',    label: 'Magic Link',       x: 766,  y: 205, href: 'login.html',                       color: 'auth',       key: 'magiclink'    },
      { id: 'password',     label: 'Password',         x: 766,  y: 310, href: 'login.html',                       color: 'auth',       key: 'password'     },
      { id: 'sixdigit',     label: '6-digit code',     x: 983,  y: 100, href: 'login.html',                       color: 'auth',       key: 'sixdigit'     },
      // Portal entry (blue, bordered)
      { id: 'portal',       label: 'Portal',           x: 1248, y: 205, href: 'portal.html',                      color: 'portal-main', key: 'portal'      },
      // Portal sub-pages (blue, no border)
      { id: 'todo',         label: 'To-do',            x: 1476, y: 0,   href: 'todo.html',                        color: 'portal-sub', key: 'todo'         },
      { id: 'company',      label: 'Company Profile',  x: 1476, y: 100, href: 'company-details.html',             color: 'portal-sub', key: 'company'      },
      { id: 'compliance',   label: 'Compliance',       x: 1476, y: 205, href: 'portal.html',                      color: 'portal-sub', key: 'compliance'   },
      { id: 'users',        label: 'Users',            x: 1476, y: 310, href: 'users.html',                       color: 'portal-sub', key: 'users'        },
      // Onboarding flow (green)
      { id: 'onboarding',   label: 'Onboarding',       x: 0,    y: 487, href: 'onboarding-welcome.html',          color: 'onboarding', key: 'onboarding'   },
      { id: 'welcome',      label: 'Welcome Page',     x: 161,  y: 487, href: 'onboarding-welcome.html',          color: 'onboarding', key: 'welcome'      },
      { id: 'business',     label: 'Business Details', x: 344,  y: 487, href: 'onboarding-business-details.html', color: 'onboarding', key: 'business'     },
      { id: 'address',      label: 'Address',          x: 539,  y: 487, href: 'onboarding-business-address.html', color: 'onboarding', key: 'address'      },
      { id: 'requirements', label: 'Requirements',     x: 674,  y: 487, href: 'onboarding-compliance-docs.html',  color: 'onboarding', key: 'requirements' },
      { id: 'keycontact',   label: 'Key contact',      x: 850,  y: 487, href: 'onboarding-key-contact.html',      color: 'onboarding', key: 'keycontact'   },
      { id: 'success',      label: 'Success',          x: 1011, y: 487, href: 'onboarding-success.html',          color: 'onboarding', key: 'success'      },
    ];

    // Each edge: [sourceId, targetId]
    var EDGES = [
      ['signin',       'otp'],
      ['signin',       'magiclink'],
      ['signin',       'password'],
      ['otp',          'sixdigit'],
      ['sixdigit',     'portal'],
      ['magiclink',    'portal'],
      ['password',     'portal'],
      ['portal',       'todo'],
      ['portal',       'company'],
      ['portal',       'compliance'],
      ['portal',       'users'],
      ['onboarding',   'welcome'],
      ['welcome',      'business'],
      ['business',     'address'],
      ['address',      'requirements'],
      ['requirements', 'keycontact'],
      ['keycontact',   'success'],
    ];

    // ── Read current page key from URL (?current=pagekey) ─────────────────────
    var currentKey = new URLSearchParams(window.location.search).get('current') || '';

    // ── Render nodes into the canvas ─────────────────────────────────────────
    var canvas = document.getElementById('mapCanvas');
    NODES.forEach(function(node) {
      var el = document.createElement('a');
      el.id = 'node-' + node.id;
      el.className = 'map-node ' + node.color + (node.key === currentKey ? ' is-current' : '');
      el.href = node.href;
      el.style.left = node.x + 'px';
      el.style.top  = node.y + 'px';
      el.textContent = node.label;
      canvas.appendChild(el);
    });

    // ── Draw SVG arrows after layout is complete ──────────────────────────────
    function drawArrows() {
      var svg = document.getElementById('mapSvg');
      var paths = '';

      EDGES.forEach(function(edge) {
        var src = document.getElementById('node-' + edge[0]);
        var tgt = document.getElementById('node-' + edge[1]);
        if (!src || !tgt) return;

        // Source: right-center; Target: left-center
        var x1 = src.offsetLeft + src.offsetWidth;
        var y1 = src.offsetTop  + Math.round(src.offsetHeight / 2);
        var x2 = tgt.offsetLeft;
        var y2 = tgt.offsetTop  + Math.round(tgt.offsetHeight / 2);

        // Cubic bezier with horizontal tangents
        var dx = Math.max(Math.abs(x2 - x1) * 0.45, 40);
        var d = 'M ' + x1 + ' ' + y1 +
                ' C ' + (x1 + dx) + ' ' + y1 + ',' +
                        (x2 - dx) + ' ' + y2 + ',' +
                        x2 + ' ' + y2;
        paths += '<path d="' + d + '" stroke="#94a3b8" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"/>';
      });

      svg.innerHTML =
        '<defs>' +
          '<marker id="arrowhead" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="userSpaceOnUse">' +
            '<path d="M0,0 L6,3 L0,6 z" fill="#94a3b8"/>' +
          '</marker>' +
        '</defs>' +
        paths;
    }

    // ── Pan & Zoom state ──────────────────────────────────────────────────────
    var viewport = document.getElementById('mapViewport');
    var panX = 0, panY = 0, scale = 1;
    var isDragging = false, startMouseX = 0, startMouseY = 0, startPanX = 0, startPanY = 0;

    function applyTransform() {
      canvas.style.transform = 'translate(' + panX + 'px,' + panY + 'px) scale(' + scale + ')';
    }

    // Fit all content into the viewport on load
    function fitView() {
      var vw = viewport.clientWidth;
      var vh = viewport.clientHeight;
      var CONTENT_W = 1720; // approximate content x-extent
      var CONTENT_H = 600;  // approximate content y-extent
      var zoomW = (vw / CONTENT_W) * 0.95;
      var zoomH = (vh / CONTENT_H) * 0.90;
      scale = Math.max(0.35, Math.min(1, Math.min(zoomW, zoomH)));
      panX = Math.max(32, (vw - CONTENT_W * scale) / 2);
      panY = Math.max(20, (vh - CONTENT_H * scale) / 2);
      applyTransform();
    }

    // Run after DOM is painted so node sizes are accurate
    requestAnimationFrame(function() {
      fitView();
      requestAnimationFrame(drawArrows);
    });

    // ── Mouse pan ─────────────────────────────────────────────────────────────
    viewport.addEventListener('mousedown', function(e) {
      if (e.button !== 0) return;
      if (e.target.closest('.map-node')) return; // let node clicks through
      isDragging = true;
      startMouseX = e.clientX;
      startMouseY = e.clientY;
      startPanX = panX;
      startPanY = panY;
      viewport.classList.add('is-dragging');
      e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      panX = startPanX + (e.clientX - startMouseX);
      panY = startPanY + (e.clientY - startMouseY);
      applyTransform();
    });

    document.addEventListener('mouseup', function() {
      if (!isDragging) return;
      isDragging = false;
      viewport.classList.remove('is-dragging');
    });

    // ── Scroll-wheel zoom (zoom to cursor position) ───────────────────────────
    viewport.addEventListener('wheel', function(e) {
      e.preventDefault();
      var rect = viewport.getBoundingClientRect();
      var mx = e.clientX - rect.left;
      var my = e.clientY - rect.top;
      // Canvas point under cursor
      var cx = (mx - panX) / scale;
      var cy = (my - panY) / scale;
      var factor = e.deltaY < 0 ? 1.12 : 0.9;
      scale = Math.max(0.2, Math.min(4, scale * factor));
      // Keep cursor point fixed
      panX = mx - cx * scale;
      panY = my - cy * scale;
      applyTransform();
    }, { passive: false });

    // ── Zoom buttons (zoom to viewport centre) ────────────────────────────────
    function zoomBy(factor) {
      var vw = viewport.clientWidth;
      var vh = viewport.clientHeight;
      var cx = (vw / 2 - panX) / scale;
      var cy = (vh / 2 - panY) / scale;
      scale = Math.max(0.2, Math.min(4, scale * factor));
      panX = vw / 2 - cx * scale;
      panY = vh / 2 - cy * scale;
      applyTransform();
    }
    document.getElementById('zoomInBtn').addEventListener('click', function() { zoomBy(1.2); });
    document.getElementById('zoomOutBtn').addEventListener('click', function() { zoomBy(1 / 1.2); });

    // ── Last updated timestamp ────────────────────────────────────────────────
    (function() {
      var d = new Date(document.lastModified);
      var pad = function(n) { return String(n).padStart(2, '0'); };
      document.getElementById('protoLastUpdated').textContent =
        'Last updated ' + pad(d.getDate()) + '/' + pad(d.getMonth() + 1) + '/' + d.getFullYear() +
        ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
    })();

    // Hide proto nav when embedded in iframe (index page thumbnail)
    if (window.self !== window.top) {
      var nav = document.querySelector('.proto-nav');
      if (nav) nav.style.display = 'none';
      document.body.style.paddingTop = '0';
    }
  </script>
</body>
</html>
