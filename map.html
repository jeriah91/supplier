<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Map – Supplier Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: #fff;
      height: 100vh;
      overflow: hidden;
      padding-top: 40px;
    }

    /* ── Proto nav ── */
    .proto-nav {
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 9999; height: 40px; background: #000;
      display: flex; align-items: center; gap: 12px; padding: 0 16px;
      font-family: 'Inter', system-ui, sans-serif;
    }
    .proto-nav-library {
      display: flex; align-items: center; gap: 8px;
      text-decoration: none; color: #fff; font-size: 14px; font-weight: 500;
      letter-spacing: -0.28px; line-height: 24px; white-space: nowrap; flex-shrink: 0;
    }
    .proto-nav-library:hover { opacity: 0.75; }
    .proto-nav-library svg { width: 20px; height: 20px; flex-shrink: 0; }
    .proto-nav-title { flex: 1; color: #fff; font-size: 14px; font-weight: 500; letter-spacing: -0.28px; line-height: 24px; }
    .proto-nav-updated { flex: 0 0 auto; color: #fff; font-size: 14px; font-weight: 400; letter-spacing: -0.28px; line-height: 24px; white-space: nowrap; }

    /* ── Map layout ── */
    .map-layout {
      position: fixed;
      top: 40px; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
    }

    .map-header {
      position: relative;
      z-index: 10;
      padding: 24px 40px 16px;
      pointer-events: none;
    }
    .map-title {
      font-size: 36px;
      font-weight: 600;
      color: #334155;
      letter-spacing: -1.44px;
      line-height: 40px;
    }

    /* ── Map viewport (pannable area) ── */
    .map-viewport {
      position: absolute;
      inset: 0;
      overflow: hidden;
      cursor: grab;
      background: #f8fafc;
    }
    .map-viewport.is-dragging { cursor: grabbing; }

    /* Dot grid — repositioned via JS to follow pan/zoom */
    .map-grid {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #cbd5e1 1.5px, transparent 1.5px);
      background-size: 24px 24px;
    }

    .map-canvas {
      position: absolute;
      left: 0; top: 0;
      width: 2400px;
      height: 850px;
      transform-origin: 0 0;
      transition: transform 0.22s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    /* Disable transition during scroll-zoom and pan so they feel direct */
    .map-canvas.no-transition { transition: none; }

    .map-svg {
      position: absolute;
      inset: 0;
      width: 2400px;
      height: 850px;
      pointer-events: none;
      overflow: visible;
    }

    /* ── Map nodes ── */
    .map-node {
      position: absolute;
      padding: 16px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #334155;
      letter-spacing: -0.32px;
      line-height: 26px;
      text-decoration: none;
      white-space: nowrap;
      cursor: pointer;
      transition: box-shadow 0.15s ease;
      user-select: none;
    }
    .map-node:hover {
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }
    .map-node.is-current {
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.06);
    }
    .map-node.auth {
      background: #ddd6fe;
      border: 1px solid #a78bfa;
    }
    .map-node.portal-main {
      background: #ccdafb;
      border: 1px solid #5483f2;
    }
    .map-node.portal-sub {
      background: #ccdafb;
    }
    .map-node.onboarding {
      background: #d1fae5;
      border: 1px solid #34d399;
    }
    .map-node.portal-drawer {
      background: #ccdafb;
      border: 1.5px dashed #5483f2;
    }
    .map-node.signout {
      background: #f1f5f9;
      border: 1px solid #94a3b8;
    }
    .map-node.modal {
      background: #fef3c7;
      border: 1.5px dashed #f59e0b;
    }

    /* ── Zoom controls ── */
    .zoom-controls {
      position: fixed;
      bottom: 24px;
      left: 24px;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }
    .zoom-btn {
      background: #fff;
      border: 1px solid #94a3b8;
      margin-bottom: -1px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #475569;
      width: 40px;
      height: 40px;
      transition: background 0.15s;
    }
    .zoom-btn:first-child { border-radius: 8px 8px 0 0; }
    .zoom-btn:last-child { border-radius: 0 0 8px 8px; margin-bottom: 0; }
    .zoom-btn:hover { background: #f1f5f9; }
    .zoom-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
  </style>
</head>
<body>

  <!-- Proto nav -->
  <nav class="proto-nav">
    <span class="proto-nav-title">Prototype / Portal</span>
    <a href="index.html" class="proto-nav-library">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
      </svg>
      Library
    </a>
    <span class="proto-nav-updated" id="protoLastUpdated"></span>
  </nav>

  <!-- Map layout -->
  <div class="map-layout">
    <div class="map-header">
      <h1 class="map-title">Map</h1>
    </div>
    <div class="map-viewport" id="mapViewport">
      <div class="map-grid" id="mapGrid"></div>
      <div class="map-canvas" id="mapCanvas">
        <svg class="map-svg" id="mapSvg"></svg>
        <!-- Nodes injected by JS -->
      </div>
    </div>
  </div>

  <!-- Zoom controls -->
  <div class="zoom-controls">
    <button class="zoom-btn" id="zoomInBtn" title="Zoom in" aria-label="Zoom in">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
      </svg>
    </button>
    <button class="zoom-btn" id="zoomOutBtn" title="Zoom out" aria-label="Zoom out">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/>
      </svg>
    </button>
  </div>

  <script>
    // ── Node definitions ──────────────────────────────────────────────────────
    // Positions match the Figma design layout (x, y = top-left of node box)
    var NODES = [
      // Auth flow (purple)
      { id: 'signin',          label: 'Sign in',           x: 574,  y: 147, href: 'login.html',                       color: 'auth',          key: 'signin'          },
      { id: 'otp',             label: 'OTP',               x: 766,  y: 100, href: 'login.html',                       color: 'auth',          key: 'otp'             },
      { id: 'magiclink',       label: 'Magic Link',        x: 766,  y: 205, href: 'login.html',                       color: 'auth',          key: 'magiclink'       },
      { id: 'password',        label: 'Password',          x: 766,  y: 310, href: 'login.html',                       color: 'auth',          key: 'password'        },
      { id: 'sixdigit',        label: '6-digit code',      x: 983,  y: 100, href: 'login.html',                       color: 'auth',          key: 'sixdigit'        },
      { id: 'magiclinksent',   label: 'Magic Link Sent',   x: 983,  y: 205, href: 'login.html',                       color: 'auth',          key: 'magiclinksent'   },
      // Portal entry (blue, bordered)
      { id: 'portal',          label: 'Portal',            x: 1248, y: 205, href: 'portal.html',                      color: 'portal-main',   key: 'portal'          },
      // Sign out (gray)
      { id: 'signout',         label: 'Sign out',          x: 1248, y: 400, href: 'login.html',                       color: 'signout',       key: 'signout'         },
      // Portal sub-pages (blue, no border)
      { id: 'todo',            label: 'To-do',             x: 1476, y: 0,   href: 'todo.html',                        color: 'portal-main',   key: 'todo'            },
      { id: 'company',         label: 'Company Profile',   x: 1476, y: 100, href: 'company-details.html',             color: 'portal-main',   key: 'company'         },
      { id: 'compliance',      label: 'Compliance',        x: 1476, y: 205, href: 'portal.html',                      color: 'portal-main',   key: 'compliance'      },
      { id: 'users',           label: 'Users',             x: 1476, y: 310, href: 'users.html',                       color: 'portal-sub',    key: 'users'           },
      // Portal drawers (blue, dashed border)
      { id: 'addperson',       label: 'Add Person',        x: 1720, y: 0,   href: 'portal.html',                      color: 'portal-drawer', key: ''                },
      { id: 'compliancedetail',label: 'Compliance Detail', x: 1720, y: 100, href: 'portal.html',                      color: 'portal-drawer', key: ''                },
      { id: 'companycomp',     label: 'Company Compliance',x: 1720, y: 205, href: 'portal.html',                      color: 'portal-drawer', key: ''                },
      // User sub-pages (blue, no border)
      { id: 'userdetail',      label: 'User Detail',       x: 1720, y: 310, href: 'user-detail.html',                 color: 'portal-main',   key: 'userdetail'      },
      { id: 'adduser',         label: 'Add User',          x: 1720, y: 420, href: 'add-user.html',                    color: 'portal-main',   key: 'adduser'         },
      // Modals (amber, dashed border)
      { id: 'deactivate',      label: 'Deactivate Profile',      x: 1960, y: 60,  href: 'portal.html',               color: 'modal',         key: ''                },
      { id: 'shareprofile',    label: 'Share Compliance Profile', x: 1960, y: 170, href: 'portal.html',               color: 'modal',         key: ''                },
      // Onboarding flow (green)
      { id: 'onboarding',      label: 'Onboarding',        x: 0,    y: 660, href: 'onboarding-welcome.html',          color: 'onboarding',    key: 'onboarding'      },
      { id: 'welcome',         label: 'Welcome Page',      x: 161,  y: 660, href: 'onboarding-welcome.html',          color: 'onboarding',    key: 'welcome'         },
      { id: 'business',        label: 'Business Details',  x: 344,  y: 660, href: 'onboarding-business-details.html', color: 'onboarding',    key: 'business'        },
      { id: 'address',         label: 'Address',           x: 539,  y: 660, href: 'onboarding-business-address.html', color: 'onboarding',    key: 'address'         },
      { id: 'requirements',    label: 'Requirements',      x: 674,  y: 660, href: 'onboarding-compliance-docs.html',  color: 'onboarding',    key: 'requirements'    },
      { id: 'keycontact',      label: 'Key contact',       x: 850,  y: 660, href: 'onboarding-key-contact.html',      color: 'onboarding',    key: 'keycontact'      },
      { id: 'success',         label: 'Success',           x: 1011, y: 660, href: 'onboarding-success.html',          color: 'onboarding',    key: 'success'         },
    ];

    // Each edge: { from, to, type? }  type: 'normal'(default) | 'vertical' | 'return'
    var EDGES = [
      { from: 'signin',          to: 'otp'             },
      { from: 'signin',          to: 'magiclink'       },
      { from: 'signin',          to: 'password'        },
      { from: 'otp',             to: 'sixdigit'        },
      { from: 'magiclink',       to: 'magiclinksent'   },
      { from: 'magiclinksent',   to: 'portal'          },
      { from: 'sixdigit',        to: 'portal'          },
      { from: 'password',        to: 'portal'          },
      { from: 'portal',          to: 'todo'            },
      { from: 'portal',          to: 'company'         },
      { from: 'portal',          to: 'compliance'      },
      { from: 'portal',          to: 'users'           },
      { from: 'portal',          to: 'signout',        type: 'vertical' },
      { from: 'signout',         to: 'signin',         type: 'return'   },
      { from: 'compliance',      to: 'addperson'       },
      { from: 'compliance',      to: 'compliancedetail'},
      { from: 'compliance',      to: 'companycomp'     },
      { from: 'users',           to: 'userdetail'      },
      { from: 'users',           to: 'adduser'         },
      { from: 'compliancedetail',to: 'deactivate'      },
      { from: 'compliancedetail',to: 'shareprofile'    },
      { from: 'success',         to: 'portal',         type: 'up' },
      { from: 'onboarding',      to: 'welcome'         },
      { from: 'welcome',         to: 'business'        },
      { from: 'business',        to: 'address'         },
      { from: 'address',         to: 'requirements'    },
      { from: 'requirements',    to: 'keycontact'      },
      { from: 'keycontact',      to: 'success'         },
    ];

    // ── Read current page key from URL (?current=pagekey) ─────────────────────
    var currentKey = new URLSearchParams(window.location.search).get('current') || '';

    // ── Render nodes into the canvas ─────────────────────────────────────────
    var canvas = document.getElementById('mapCanvas');
    NODES.forEach(function(node) {
      var el = document.createElement('a');
      el.id = 'node-' + node.id;
      el.className = 'map-node ' + node.color + (node.key && node.key === currentKey ? ' is-current' : '');
      el.href = node.href;
      el.style.left = node.x + 'px';
      el.style.top  = node.y + 'px';
      el.textContent = node.label;
      canvas.appendChild(el);
    });

    // ── Draw SVG arrows after layout is complete ──────────────────────────────
    function drawArrows() {
      var svg = document.getElementById('mapSvg');
      var paths = '';

      EDGES.forEach(function(edge) {
        var fromId = edge.from;
        var toId   = edge.to;
        var type   = edge.type || 'normal';

        var src = document.getElementById('node-' + fromId);
        var tgt = document.getElementById('node-' + toId);
        if (!src || !tgt) return;

        var x1, y1, x2, y2, d, stroke, marker, extra;
        stroke = '#94a3b8';
        marker = 'url(#arrowhead)';
        extra  = '';

        if (type === 'vertical') {
          // Bottom-center of src → top-center of tgt (for portal → signout)
          x1 = src.offsetLeft + Math.round(src.offsetWidth / 2);
          y1 = src.offsetTop  + src.offsetHeight;
          x2 = tgt.offsetLeft + Math.round(tgt.offsetWidth / 2);
          y2 = tgt.offsetTop;
          var dy = Math.max(Math.abs(y2 - y1) * 0.45, 20);
          d = 'M ' + x1 + ' ' + y1 +
              ' C ' + x1 + ' ' + (y1 + dy) + ',' +
                      x2 + ' ' + (y2 - dy) + ',' +
                      x2 + ' ' + y2;

        } else if (type === 'up') {
          // Top-center of src → bottom-center of tgt (for success → portal)
          x1 = src.offsetLeft + Math.round(src.offsetWidth / 2);
          y1 = src.offsetTop;
          x2 = tgt.offsetLeft + Math.round(tgt.offsetWidth / 2);
          y2 = tgt.offsetTop + tgt.offsetHeight;
          var dy = Math.max(Math.abs(y1 - y2) * 0.45, 20);
          d = 'M ' + x1 + ' ' + y1 +
              ' C ' + x1 + ' ' + (y1 - dy) + ',' +
                      x2 + ' ' + (y2 + dy) + ',' +
                      x2 + ' ' + y2;
          stroke = '#34d399';  // green to match onboarding

        } else if (type === 'return') {
          // Bottom-center of src → arc through midY → bottom-center of tgt
          // Used for signout → signin (sweep below portal, re-enter signin from below)
          x1 = src.offsetLeft + Math.round(src.offsetWidth / 2);
          y1 = src.offsetTop  + src.offsetHeight;
          x2 = tgt.offsetLeft + Math.round(tgt.offsetWidth / 2);
          y2 = tgt.offsetTop  + tgt.offsetHeight;
          var midY = 580;
          d = 'M ' + x1 + ' ' + y1 +
              ' C ' + x1 + ' ' + midY + ',' +
                      x2 + ' ' + midY + ',' +
                      x2 + ' ' + y2;
          stroke = '#cbd5e1';
          extra  = ' stroke-dasharray="6,4"';
          marker = 'url(#arrowhead-light)';

        } else {
          // Normal: right-center of src → left-center of tgt
          x1 = src.offsetLeft + src.offsetWidth;
          y1 = src.offsetTop  + Math.round(src.offsetHeight / 2);
          x2 = tgt.offsetLeft;
          y2 = tgt.offsetTop  + Math.round(tgt.offsetHeight / 2);
          var dx = Math.max(Math.abs(x2 - x1) * 0.45, 40);
          d = 'M ' + x1 + ' ' + y1 +
              ' C ' + (x1 + dx) + ' ' + y1 + ',' +
                      (x2 - dx) + ' ' + y2 + ',' +
                      x2 + ' ' + y2;
        }

        paths += '<path d="' + d + '" stroke="' + stroke + '" stroke-width="1.5" fill="none"' + extra + ' marker-end="' + marker + '"/>';
      });

      svg.innerHTML =
        '<defs>' +
          '<marker id="arrowhead" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="userSpaceOnUse">' +
            '<path d="M0,0 L6,3 L0,6 z" fill="#94a3b8"/>' +
          '</marker>' +
          '<marker id="arrowhead-light" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="userSpaceOnUse">' +
            '<path d="M0,0 L6,3 L0,6 z" fill="#cbd5e1"/>' +
          '</marker>' +
        '</defs>' +
        paths;
    }

    // ── Pan & Zoom state ──────────────────────────────────────────────────────
    var viewport = document.getElementById('mapViewport');
    var grid = document.getElementById('mapGrid');
    var panX = 0, panY = 0, scale = 1;
    var isDragging = false, startMouseX = 0, startMouseY = 0, startPanX = 0, startPanY = 0;
    var wheelTimer;

    function applyTransform() {
      canvas.style.transform = 'translate(' + panX + 'px,' + panY + 'px) scale(' + scale + ')';
      // Dots pan with the canvas but stay fixed size (spacing never scales)
      var spacing = 24;
      var ox = ((panX % spacing) + spacing) % spacing;
      var oy = ((panY % spacing) + spacing) % spacing;
      grid.style.backgroundPosition = ox + 'px ' + oy + 'px';
    }

    // Fit all content into the viewport on load
    function fitView() {
      var vw = viewport.clientWidth;
      var vh = viewport.clientHeight;
      var CONTENT_W = 2200; // approximate content x-extent
      var CONTENT_H = 790;  // approximate content y-extent
      var zoomW = (vw / CONTENT_W) * 0.95;
      var zoomH = (vh / CONTENT_H) * 0.90;
      scale = Math.max(0.35, Math.min(1, Math.min(zoomW, zoomH)));
      panX = Math.max(32, (vw - CONTENT_W * scale) / 2);
      panY = Math.max(20, (vh - CONTENT_H * scale) / 2);
      applyTransform();
    }

    // Run after DOM is painted so node sizes are accurate
    requestAnimationFrame(function() {
      fitView();
      requestAnimationFrame(drawArrows);
    });

    // ── Mouse pan ─────────────────────────────────────────────────────────────
    viewport.addEventListener('mousedown', function(e) {
      if (e.button !== 0) return;
      if (e.target.closest('.map-node')) return; // let node clicks through
      canvas.classList.add('no-transition'); // pan must be instant
      isDragging = true;
      startMouseX = e.clientX;
      startMouseY = e.clientY;
      startPanX = panX;
      startPanY = panY;
      viewport.classList.add('is-dragging');
      e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      panX = startPanX + (e.clientX - startMouseX);
      panY = startPanY + (e.clientY - startMouseY);
      applyTransform();
    });

    document.addEventListener('mouseup', function() {
      if (!isDragging) return;
      isDragging = false;
      viewport.classList.remove('is-dragging');
      canvas.classList.remove('no-transition');
    });

    // ── Scroll-wheel zoom (zoom to cursor position) ───────────────────────────
    viewport.addEventListener('wheel', function(e) {
      e.preventDefault();
      canvas.classList.add('no-transition'); // scroll zoom must be instant
      var rect = viewport.getBoundingClientRect();
      var mx = e.clientX - rect.left;
      var my = e.clientY - rect.top;
      // Canvas point under cursor
      var cx = (mx - panX) / scale;
      var cy = (my - panY) / scale;
      var factor = e.deltaY < 0 ? 1.12 : 0.9;
      scale = Math.max(0.2, Math.min(4, scale * factor));
      // Keep cursor point fixed
      panX = mx - cx * scale;
      panY = my - cy * scale;
      applyTransform();
      // Re-enable transition shortly after wheel stops
      clearTimeout(wheelTimer);
      wheelTimer = setTimeout(function() {
        canvas.classList.remove('no-transition');
      }, 150);
    }, { passive: false });

    // ── Zoom buttons (zoom to viewport centre, animated) ─────────────────────
    function zoomBy(factor) {
      canvas.classList.remove('no-transition'); // ensure transition is active
      var vw = viewport.clientWidth;
      var vh = viewport.clientHeight;
      var cx = (vw / 2 - panX) / scale;
      var cy = (vh / 2 - panY) / scale;
      scale = Math.max(0.2, Math.min(4, scale * factor));
      panX = vw / 2 - cx * scale;
      panY = vh / 2 - cy * scale;
      applyTransform();
    }
    document.getElementById('zoomInBtn').addEventListener('click', function() { zoomBy(1.2); });
    document.getElementById('zoomOutBtn').addEventListener('click', function() { zoomBy(1 / 1.2); });

    // ── Last updated timestamp ────────────────────────────────────────────────
    (function() {
      var d = new Date(document.lastModified);
      var pad = function(n) { return String(n).padStart(2, '0'); };
      document.getElementById('protoLastUpdated').textContent =
        'Last updated ' + pad(d.getDate()) + '/' + pad(d.getMonth() + 1) + '/' + d.getFullYear() +
        ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
    })();

    // Hide proto nav when embedded in iframe (index page thumbnail)
    if (window.self !== window.top) {
      var nav = document.querySelector('.proto-nav');
      if (nav) nav.style.display = 'none';
      document.body.style.paddingTop = '0';
    }
  </script>
</body>
</html>
